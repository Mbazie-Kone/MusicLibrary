services:
  minio:
    image: quay.io/minio/minio
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001" # MinIO Console
    environment:
      MINIO_ROOT_USER: "minioadmin"
      MINIO_ROOT_PASSWORD: "minioadmin"
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - musicnetwork    
    
  api:
    build:
      context: .
      dockerfile: MusicLibrary.Api/Dockerfile
    container_name: musiclibrary-api
    ports:
      - "5000:5000"
      - "5001:5001"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: "Server=db;Database=MusicLibraryDb;User Id=sa;Password=12345678aA!;TrustServerCertificate=True;"
      Minio__Endpoint: "minio:9000"
      Minio__AccessKey: "minioadmin"
      Minio__SecretKey: "minioadmin"
      Minio__BucketName: "media"
    depends_on:
      - db
      - minio
    networks:
      - musicnetwork
  
  mediaprocessor:
    build:
      context: .
      dockerfile: MediaProcessor/Dockerfile
    depends_on:
      - db
      - minio
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ConnectionStrings__DefaultConnection: "Server=db;Database=MusicLibraryDb;User Id=sa;Password=12345678aA!;TrustServerCertificate=True;"
      Minio__Endpoint: "minio:9000"
      Minio__AccessKey: "minioadmin"
      Minio__SecretKey: "minioadmin"
      Minio__BucketName: "media"
    networks:
      - musicnetwork
  
  mediaprocessor:
    build:
      context: .
      dockerfile: MediaProcessor/Dockerfile
    depends_on:
      - db
      - minio
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
    networks:
      - musicnetwork

  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: musiclibrary-db
    environment:
      SA_PASSWORD: "12345678aA!"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - dbdata:/var/opt/mssql
    networks:
      - musicnetwork
      
  frontend:
    build:
      context: ./frontend/music-library-ui
      dockerfile: Dockerfile
    container_name: musiclibrary-frontend
    ports:
      - "4200:80"
    depends_on:
      - api
    networks:
      - musicnetwork

volumes:
  dbdata:
  minio_data:
  
networks:
  musicnetwork:
    driver: bridge
